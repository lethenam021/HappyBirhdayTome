<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ch√∫c m·ª´ng sinh nh·∫≠t üéâ</title>
  <meta name="description" content="Thi·ªáp HTML ch√∫c m·ª´ng sinh nh·∫≠t hi·ªán ƒë·∫°i, sang tr·ªçng, nhi·ªÅu hi·ªáu ·ª©ng v√† ch·ª©c nƒÉng t∆∞∆°ng t√°c th√¥ng minh." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Fraunces:wght@600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#7b5cff;
      --secondary:#ff6ec7;
      --accent:#ffd479;
      --bg:#0f0f1a;
      --glass:rgba(255,255,255,.06);
      --text:#ffffff;
      --panel:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.18);
    }
    .code-unlock {
  margin-top: 15px;
  display: flex;
  gap: 6px;
}
.code-unlock input {
  flex: 1;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
}
.code-unlock button {
  background: #4caf50;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
}
.code-unlock button:hover {
  background: #45a049;
}

    .light{
      --bg:#f6f7fb;
      --glass:#ffffff;
      --text:#111111;
      --panel:#ffffff;
      --border:rgba(0,0,0,.08);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(135deg,var(--bg),#1e1e2f);
      color:var(--text);
      font-family:"Inter",sans-serif;
      overflow:auto;
      transition:background .4s ease,color .4s ease;
    }
    .light body, body.light{ background:#f6f7fb; }

    .card{
      position:relative;
      max-width:1100px;
      width:95%;
      border-radius:32px;
      padding:40px;
      background:var(--glass);
      backdrop-filter:blur(20px);
      box-shadow:0 20px 50px rgba(0,0,0,.15);
      text-align:center;
      animation:fadeIn 1.0s ease forwards;
      margin:40px auto;
      border:1px solid var(--border);
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}

    h1{
      font-family:"Fraunces",serif;
      font-size:clamp(44px,7.4vw,76px);
      background:linear-gradient(90deg,var(--accent),#fff,var(--secondary));
      background-size:300% 100%;
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      animation:shine 8s linear infinite;
      margin-bottom:16px;
    }
    @keyframes shine{50%{background-position:100% 0}}

    .subtitle{font-size:clamp(18px,2.5vw,22px);opacity:.85;margin-bottom:28px;}

    .msg{font-size:clamp(18px,2.7vw,22px);margin-bottom:28px;line-height:1.7;white-space:pre-line;min-height:60px;}

    .controls{display:flex;justify-content:center;gap:14px;flex-wrap:wrap;margin-bottom:20px}
    .btn{padding:12px 20px;border-radius:14px;border:0;cursor:pointer;font-weight:700;letter-spacing:.3px;box-shadow:0 8px 24px rgba(0,0,0,.15);transition:transform .25s ease,opacity .2s ease;border:1px solid var(--border); background:var(--panel); color:var(--text)}
    .btn:active{transform:scale(.96)}
    .btn:hover{transform:translateY(-2px)}
    .primary{background:linear-gradient(90deg,var(--primary),var(--secondary));color:#fff;border:none}

    .footer{margin-top:36px;font-size:14px;display:flex;justify-content:center;gap:14px;flex-wrap:wrap;opacity:.8}
    .footer span{background:rgba(255,255,255,.08);padding:8px 14px;border-radius:999px;border:1px solid var(--border)}

    canvas{position:fixed;inset:0;width:100%;height:100%;pointer-events:none}

    .orb{position:absolute;width:280px;height:280px;border-radius:50%;background:radial-gradient(circle,var(--primary),transparent 70%);filter:blur(120px);opacity:.35;animation:float 18s ease-in-out infinite alternate;z-index:-1}
    .orb2{background:radial-gradient(circle,var(--secondary),transparent 70%);top:20%;left:70%;animation-delay:-6s}
    @keyframes float{from{transform:translateY(-40px)}to{transform:translateY(40px)}}

    /* Guestbook */
    .guestbook{margin:28px auto 8px; text-align:left; max-width:720px}
    .gb-header{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px}
    .gb-title{font-weight:800; letter-spacing:.3px; font-size:clamp(18px,2.2vw,22px)}
    .gb-actions{display:flex; gap:8px; flex-wrap:wrap}
    .chip{background:rgba(255,255,255,.08); border:1px solid var(--border); color:var(--text); padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:600}
    .gb-form{display:grid; grid-template-columns:1fr 2fr auto; gap:10px; align-items:start}
    .input, .textarea{background:rgba(255,255,255,.06); border:1px solid var(--border); color:var(--text); border-radius:12px; padding:12px 14px; outline:none}
    .textarea{min-height:56px; resize:vertical}
    .gb-submit{padding:12px 16px; border-radius:12px; border:0; font-weight:800; cursor:pointer; background:linear-gradient(90deg,var(--primary),var(--secondary)); color:#111}
    .counter{font-size:12px; opacity:.8; text-align:right; grid-column:2/3}
    .gb-list{margin-top:12px; display:grid; gap:10px}
    .gb-item{background:rgba(255,255,255,.06); border:1px solid var(--border); padding:12px 14px; border-radius:14px; display:grid; gap:6px}
    .gb-item h4{margin:0; font-size:14px; opacity:.9}
    .gb-item p{margin:0; line-height:1.5}
    .gb-meta{display:flex; gap:10px; font-size:12px; opacity:.7; flex-wrap:wrap}
    .gb-empty{opacity:.7; text-align:center; padding:16px}
    .tools{display:flex; gap:8px; margin-top:6px}
    .icon-btn{background:transparent; border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer}
    @media (max-width:720px){.gb-form{grid-template-columns:1fr;}.gb-submit{width:100%}.counter{grid-column:1/2;}}

    /* New features */
    .countdown{font-size:20px;margin:20px 0;font-weight:600}
    audio{margin-top:16px;width:100%}
    .theme-toggle{margin:20px auto;display:flex;justify-content:center;gap:12px}
    .qr{margin:20px auto;}
    .layout-switch{margin:20px auto;display:flex;justify-content:center;gap:12px}

    /* Layout modifiers */
    .layout-default{display:block; text-align:center}
    .layout-split{display:grid; grid-template-columns:1fr 1fr; gap:20px; text-align:left}
    .layout-split #guestbook{grid-column:1 / -1; max-width:100%}
    .layout-split .gb-form{grid-template-columns:1fr 2fr auto}
    .layout-split .textarea{min-height:140px}
    .layout-minimal{display:block; text-align:center; background:#ffffff !important; color:#111 !important}

    /* Badge */
    .badge{font-size:12px; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid var(--border)}

    /* QR actions */
    .qr-actions{display:flex; justify-content:center; gap:10px; margin-top:10px}
    .qr canvas, .qr img{image-rendering:pixelated;}
     /* Cake animation */
    .cake{margin:10px auto 16px; width:clamp(160px,28vw,260px)}
    .cake svg{display:block; margin:0 auto}
    .flame{transform-origin:center bottom; animation:flame 1.2s ease-in-out infinite}
    @keyframes flame{0%{transform:translateY(0) scale(1);opacity:.95}50%{transform:translateY(-1px) scale(1.06);opacity:1}100%{transform:translateY(1px) scale(.96);opacity:.9}}
    .glow{animation:glow 1.6s ease-in-out infinite; transform-origin:center}
    @keyframes glow{0%,100%{opacity:.35}50%{opacity:.7}}
  
    /* Pro cake polish */
    .cake svg{filter:drop-shadow(0 12px 28px rgba(0,0,0,.25));}
    .cake .flame{filter: drop-shadow(0 0 14px rgba(255,183,77,.65));}
    .cake .glow{filter: blur(2px)}
    .cake-controls{display:flex;gap:10px;justify-content:center;margin:4px 0 14px}
    .cake .smoke circle{opacity:0}
    .cake.candle-off .flame, .cake.candle-off .glow{opacity:0}
    .cake.candle-off .smoke .s1{animation:rise 2.2s ease-out infinite .0s; opacity:.6}
    .cake.candle-off .smoke .s2{animation:rise 2.4s ease-out infinite .4s; opacity:.6}
    .cake.candle-off .smoke .s3{animation:rise 2.6s ease-out infinite .8s; opacity:.6}
    @keyframes rise{0%{transform:translateY(0) scale(.9);opacity:.55}70%{opacity:.15}100%{transform:translateY(-36px) scale(1.3);opacity:0}}
  </style>
</head>
<body>
  <div class="orb"></div>
  <div class="orb orb2"></div>
  <canvas id="confetti"></canvas>

  <section class="card layout-default" id="card" aria-live="polite">
    <h1>G·ª≠i nh·ªØng l·ªùi ch√∫c t·ªët ƒë·∫πp nh·∫•t  cho , <span id="name">Ng∆∞·ªùi b·∫°n</span> üéÇ</h1>
    <p class="subtitle">M·ªôt ng√†y tuy·ªát v·ªùi tr√†n ng·∫≠p ni·ªÅm vui v√† h·∫°nh ph√∫c!</p>
 <div class="cake" aria-label="B√°nh kem v·ªõi n·∫øn ƒëang ch√°y">
      <svg viewBox="0 0 200 200" width="100%" height="auto" role="img" aria-label="Birthday cake with candle">
        <defs>
          <linearGradient id="cakeBody" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#ffe3ec"/>
            <stop offset="100%" stop-color="#ffc0d4"/>
          </linearGradient>
          <linearGradient id="icing" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#ffffff"/>
            <stop offset="100%" stop-color="#ffe9f3"/>
          </linearGradient>
          <radialGradient id="flameGrad" cx="50%" cy="35%" r="60%">
            <stop offset="0%" stop-color="#fff6a9"/>
            <stop offset="60%" stop-color="#ffd479"/>
            <stop offset="100%" stop-color="rgba(255,212,121,0)"/>
          </radialGradient>
        </defs>
        <!-- Plate -->
        <ellipse cx="100" cy="172" rx="70" ry="10" fill="rgba(0,0,0,.18)"/>
        <!-- Cake body -->
        <rect x="45" y="95" width="110" height="60" rx="12" fill="url(#cakeBody)" stroke="rgba(0,0,0,.08)"/>
        <!-- Icing top -->
        <path d="M50 100 h100 a10 10 0 0 1 10 10 v6 c-6 8-14 4-20 0 s-10 8-20 0 s-14 8-22 0 s-14 8-22 0 s-12 6-26 0 v-6 a10 10 0 0 1 10-10z" fill="url(#icing)"/>
        <!-- Candle -->
        <rect x="95" y="65" width="10" height="35" rx="3" fill="#7b5cff"/>
        <path d="M95 76 h10" stroke="#fff" stroke-width="3" opacity=".7"/>
        <path d="M95 88 h10" stroke="#fff" stroke-width="3" opacity=".6"/>
        <!-- Flame glow -->
        <ellipse class="glow" cx="100" cy="60" rx="16" ry="18" fill="url(#flameGrad)"/>
        <!-- Flame -->
        $1
        <g class="smoke">
          <circle class="s1" cx="100" cy="60" r="3" fill="rgba(255,255,255,.85)"/>
          <circle class="s2" cx="100" cy="64" r="2.6" fill="rgba(255,255,255,.75)"/>
          <circle class="s3" cx="100" cy="68" r="2.2" fill="rgba(255,255,255,.65)"/>
        </g>
      </svg>
    </div>

    <div class="cake-controls">
      <button class="btn" id="btnBlow">üïØÔ∏è Th·ªïi n·∫øn</button>
      <button class="btn" id="btnLight">üî• Th·∫Øp n·∫øn</button>
    </div>

    <p class="msg" id="typed"></p>

    <div class="controls" role="group" aria-label="Hi·ªáu ·ª©ng & Ti·ªán √≠ch">
      <button class="btn primary" id="btnConfetti">üéä B·∫Øn confetti</button>
      <button class="btn" id="btnFireworks">‚ú® Ph√°o hoa</button>
      <button class="btn" id="btnDownload">üì∑ T·∫£i ·∫£nh</button>
    </div>

    <div id="countdown" class="countdown" aria-live="polite"></div>
      <div class="music-player" id="musicPlayer">
    <audio id="bgMusic" controls loop>
      <source src="HappyBirthday-PhanDinhTung_uwaw.mp3" type="audio/mpeg">
      Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ audio.
    </audio>
    </div>

    <div class="theme-toggle">
      <button class="btn" id="lightMode">üåû Light</button>
      <button class="btn" id="darkMode">üåô Dark</button>
    </div>

    <div class="layout-switch">
      <button class="btn" id="layoutDefault">üìê Layout Chu·∫©n</button>
      <button class="btn" id="layoutSplit">üìë Layout 2 c·ªôt</button>
      <button class="btn" id="layoutMinimal">‚ö™ T·ªëi gi·∫£n</button>
    </div>

    <div class="qr" id="qr" title="QR ƒë·ªÉ chia s·∫ª thi·ªáp"></div>
    <div class="qr-actions">
      <button class="btn" id="btnSaveQR">üíæ L∆∞u QR</button>
      <button class="btn" id="btnShareQR">üîó Chia s·∫ª QR</button>
    </div>

    <section class="guestbook" id="guestbook">
      <div class="gb-header">
        <div class="gb-title">üí¨ S·ªï l·ªùi ch√∫c c·ªßa b·∫°n b√® <span class="badge" id="gbCount">0</span></div>
        <div class="gb-actions">
          <button class="icon-btn" id="btnImport">‚¨ÜÔ∏è Nh·∫≠p</button>
          <button class="icon-btn" id="btnExport">‚¨áÔ∏è T·∫£i</button>
          <button class="icon-btn" id="btnPrint">üñ®Ô∏è In</button>
          <button class="icon-btn" id="btnShare">üîó Chia s·∫ª</button>
          <button class="icon-btn" id="btnClear">üßπ Xo√°</button>
          <input type="file" id="fileInput" accept="application/json" hidden />
        </div>
      </div>
      <div class="gb-form">
        <input class="input" id="gbName" placeholder="T√™n c·ªßa b·∫°n" maxlength="40"/>
        <textarea class="textarea" id="gbMsg" placeholder="Vi·∫øt l·ªùi ch√∫c (t·ªëi ƒëa 200 k√Ω t·ª±)" maxlength="200"></textarea>
        <button class="gb-submit" id="gbAdd">G·ª≠i</button>
        
        <div class="counter"><span id="remain">200</span> k√Ω t·ª±</div>
        <div class="tools" aria-label="Ch√®n nhanh bi·ªÉu t∆∞·ª£ng">
          <button type="button" class="chip" data-emoji="üéâ">üéâ</button>
          <button type="button" class="chip" data-emoji="üéÇ">üéÇ</button>
          <button type="button" class="chip" data-emoji="üíñ">üíñ</button>
          <button type="button" class="chip" data-emoji="‚ú®">‚ú®</button>
        </div>
      </div>
            <!-- Popup c·∫£m ∆°n -->
      <div id="thankPopup" class="popup-overlay">
        <div class="popup-content">
          <span class="popup-close">&times;</span>
          <h2>üéâ C·∫£m ∆°n b·∫°n!</h2>
          <p>L·ªùi ch√∫c c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng üíñ</p>
        </div>
      </div>
      <style>

.gb-submit {
  background: #ff4081; color: #fff; border: none;
  padding: 10px 20px; border-radius: 8px;
  cursor: pointer; font-size: 15px;
}
.gb-submit:hover { background: #e73370; }
.counter { font-size: 13px; margin-top: 5px; color: #555; }
.tools { margin-top: 10px; }
.chip {
  background: #f3f3f3; border: 1px solid #ddd;
  border-radius: 6px; padding: 6px 10px; margin-right: 5px;
  cursor: pointer; font-size: 16px;
}
.chip:hover { background: #eee; }

/* Popup */
.popup-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: none; justify-content: center; align-items: center;
  z-index: 9999;
}
.popup-content {
  background: #fff; padding: 20px 30px; border-radius: 12px;
  text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  animation: popupIn 0.3s ease; max-width: 350px; position: relative;
}
.popup-content h2 { margin-bottom: 10px; color: #ff4081; }
.popup-close {
  position: absolute; top: 10px; right: 15px;
  font-size: 22px; cursor: pointer; color: #555;
}
@keyframes popupIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
</style>
      <div class="gb-list" id="gbList"><div class="gb-empty">Ch∆∞a c√≥ l·ªùi ch√∫c n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n! ü•∞</div></div>
    </section>

    <div class="footer">
      <span>üìÖ <span id="date"></span></span>
      <span>üíå T·ª´ <span id="author">B·∫°n b√® & Gia ƒë√¨nh</span></span>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
  // ===== Helpers =====
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const params = new URLSearchParams(location.search);

  function sanitizeKey(s){
    return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').slice(0,40)||'guest';
  }

  // ===== Config with URL overrides =====
  const CONFIG = {
    recipientName: params.get('name') || 'L√™ Th√™ Nam',
    author: params.get('author') || 'Gia ƒë√¨nh & B·∫°n b√®',
    birthday: params.get('birthday') || '2025-09-17T16:41:00',
    messageLines: (params.get('msg') ? decodeURIComponent(params.get('msg')).split('\n') : [
      'Ch√∫c tu·ªïi m·ªõi lu√¥n m·∫°nh kh·ªèe v√† m·ªâm c∆∞·ªùi m·ªói ng√†y!',
      'Mong m·ªçi d·ª± ƒë·ªãnh ƒë·ªÅu th√†nh c√¥ng r·ª±c r·ª°.',
      'Lu√¥n ƒë∆∞·ª£c y√™u th∆∞∆°ng v√† h·∫°nh ph√∫c tr·ªçn v·∫πn! üíñ'
    ])
  };

  const THEME_KEY = 'hb:theme';
  const LAYOUT_KEY = 'hb:layout';
  const GB_KEY = `hb:guestbook:${sanitizeKey(CONFIG.recipientName)}`;

  // ===== Static text fill =====
  $('#name').textContent = CONFIG.recipientName;
  $('#author').textContent = CONFIG.author;
  $('#date').textContent = new Date().toLocaleDateString('vi-VN',{year:'numeric',month:'long',day:'numeric'});

  // ===== Typewriter =====
  (function type(lines, el){
    let li=0,i=0; el.textContent='';
    function step(){
      if(li>=lines.length) return;
      const line = lines[li];
      el.textContent=line.slice(0,++i);
      if(i<=line.length){ setTimeout(step, 32); }
      else { li++; i=0; setTimeout(()=>{ el.textContent += "\n"; step(); }, 600); }
    }
    step();
  })(CONFIG.messageLines, $('#typed'));

  // ===== Confetti / Fireworks =====
  const cvs=$('#confetti');
  const ctx=cvs.getContext('2d'); let W,H,parts=[]; resize();
  addEventListener('resize',resize);
  function resize(){ W=cvs.width=innerWidth; H=cvs.height=innerHeight; }
  function burst(cx=W/2,cy=H/3,count=180){
    for(let i=0;i<count;i++){
      const a=Math.random()*Math.PI*2,s=Math.random()*6+2;
      parts.push({x:cx,y:cy,vx:Math.cos(a)*s,vy:Math.sin(a)*s-2,g:.1+Math.random()*.05,size:2+Math.random()*4,col:`hsl(${Math.random()*360},80%,70%)`});
    }
  }
  function tick(){
    ctx.clearRect(0,0,W,H);
    parts=parts.filter(p=>p.y<H+60);
    for(const p of parts){ p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; ctx.fillStyle=p.col; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill(); }
    requestAnimationFrame(tick);
  }
  tick();
  $('#btnConfetti').addEventListener('click',()=>burst());
  $('#btnFireworks').addEventListener('click',()=>burst(Math.random()*W,Math.random()*H/2,260));
  setTimeout(()=>burst(),600);


// Th·ªùi ƒëi·ªÉm m·ª•c ti√™u (ISO)
const target = new Date("2025-09-17T16:53:00");

function scheduleFireworks() {
  const now = new Date();
  const diff = target.getTime() - now.getTime();

  if (diff <= 0) {
    startFireworks();
  } else {
    setTimeout(startFireworks, diff);
  }
}

function startFireworks() {
  const interval = setInterval(() => {
    burst(Math.random() * W, Math.random() * H / 2, 260);
  }, 500); // m·ªói 0.5 gi√¢y b·∫Øn 1 l·∫ßn

  // Sau 1 ph√∫t th√¨ d·ª´ng
  setTimeout(() => clearInterval(interval), 60 * 1000);
}

// G·ªçi khi load trang
scheduleFireworks();


  
 // ===== Countdown =====
let countdownTimer; // gi·ªØ id interval ƒë·ªÉ clear khi c·∫ßn

function updateCountdown(){
  const target = new Date(CONFIG.birthday);
  const now = new Date();
  const diff = target - now;
  const el = document.querySelector('#countdown');

  if (isNaN(target.getTime())) { 
    el.textContent = ''; 
    return; 
  }

  if (diff <= 0) {
    el.textContent = 'üéâ H√¥m nay l√† sinh nh·∫≠t! Ch√∫c m·ª´ng!';
    clearInterval(countdownTimer); // d·ª´ng interval, kh√¥ng c·∫ßn ƒë·ª£i 1 ph√∫t
    return;
  }

  const d = Math.floor(diff / 86400000),
        h = Math.floor(diff / 3600000) % 24,
        m = Math.floor(diff / 60000) % 60;

  el.textContent = `‚è≥ C√≤n ${d} ng√†y ${h} gi·ªù ${m} ph√∫t ƒë·∫øn sinh nh·∫≠t`;
}

// ch·∫°y ngay khi load
updateCountdown();
// sau ƒë√≥ c·ª© m·ªói ph√∫t c·∫≠p nh·∫≠t l·∫°i
countdownTimer = setInterval(updateCountdown, 60000);


  // ===== Theme toggle (persist) =====
  const applyTheme = (mode) => {
    if(mode==='light'){ document.body.classList.add('light'); }
    else { document.body.classList.remove('light'); }
    localStorage.setItem(THEME_KEY, mode);
  };
  const savedTheme = params.get('theme') || localStorage.getItem(THEME_KEY) || 'dark';
  applyTheme(savedTheme);
  $('#lightMode').addEventListener('click',()=>applyTheme('light'));
  $('#darkMode').addEventListener('click',()=>applyTheme('dark'));

  // ===== Layout switch (persist) =====
  const card=$('#card');
  function setLayout(kind){
    card.classList.remove('layout-default','layout-split','layout-minimal');
    if(kind==='split') card.classList.add('layout-split');
    else if(kind==='minimal') card.classList.add('layout-minimal');
    else card.classList.add('layout-default');
    localStorage.setItem(LAYOUT_KEY, kind);
  }
  setLayout(localStorage.getItem(LAYOUT_KEY) || 'default');
  $('#layoutDefault').addEventListener('click',()=>setLayout('default'));
  $('#layoutSplit').addEventListener('click',()=>setLayout('split'));
  $('#layoutMinimal').addEventListener('click',()=>setLayout('minimal'));

  // ===== QR Code + Save/Share =====
  new QRCode($('#qr'), { text: location.href, width: 128, height: 128, colorDark:'#000', colorLight:'#fff', correctLevel: QRCode.CorrectLevel.H });
  function getQrElement(){ return $('#qr').querySelector('canvas') || $('#qr').querySelector('img'); }
  function getQrDataURL(){
    const el = getQrElement();
    if(!el) return null;
    if(el.tagName==='CANVAS') return el.toDataURL('image/png');
    if(el.tagName==='IMG') return el.src;
    return null;
  }
  function downloadDataUrl(dataUrl, filename){ const a=document.createElement('a'); a.href=dataUrl; a.download=filename; a.click(); }
  async function dataUrlToBlob(dataUrl){ const res = await fetch(dataUrl); return await res.blob(); }
  $('#btnSaveQR').addEventListener('click',()=>{ const url = getQrDataURL(); if(url) downloadDataUrl(url, 'qr-sinh-nhat.png'); });
  $('#btnShareQR').addEventListener('click', async ()=>{
    const url = getQrDataURL(); if(!url){ alert('Ch∆∞a t·∫°o ƒë∆∞·ª£c QR'); return; }
    try{
      const blob = await dataUrlToBlob(url);
      const file = new File([blob], 'qr-sinh-nhat.png', {type:'image/png'});
      if(navigator.canShare && navigator.canShare({files:[file]})){
        await navigator.share({ files:[file], title: document.title, text:`QR thi·ªáp m·ª´ng ${CONFIG.recipientName}` });
      } else {
        downloadDataUrl(url, 'qr-sinh-nhat.png');
        alert('Tr√¨nh duy·ªát ch∆∞a h·ªó tr·ª£ chia s·∫ª file tr·ª±c ti·∫øp. ƒê√£ t·∫£i ·∫£nh QR thay th·∫ø.');
      }
    }catch{ downloadDataUrl(url, 'qr-sinh-nhat.png'); }
  });

  // ===== Download card as image =====
  $('#btnDownload').addEventListener('click',()=>{
    html2canvas(document.querySelector('.card'), {backgroundColor: null, useCORS:true, scale:2}).then(canvas=>{
      const link=document.createElement('a'); link.download='thiep-sinh-nhat.png'; link.href=canvas.toDataURL('image/png'); link.click();
    });
  });

function setupMusicPlayer() 
    {
      const musicPlayer = document.getElementById('musicPlayer');
      const bgMusic = document.getElementById('bgMusic');
      let isPlaying = false;
      
      musicPlayer.addEventListener('click', function() {
        if (isPlaying) {
          bgMusic.pause();
          musicPlayer.innerHTML = '<div class="music-icon">üéµ</div>';
        } else {
          bgMusic.play();
          musicPlayer.innerHTML = '<div class="music-icon">üîä</div>';
        }
        isPlaying = !isPlaying;
      });
      
      // T·ª± ƒë·ªông b·∫≠t nh·∫°c khi m·ªü h·ªôp qu√†
      document.getElementById('giftBox').addEventListener('click', function() {
        if (!isPlaying) {
          // T·∫°o hi·ªáu ·ª©ng ƒë·∫øm ng∆∞·ª£c tr∆∞·ªõc khi ph√°t nh·∫°c
          const countdown = document.getElementById('countdown');
          const countdownNumber = document.getElementById('countdown-number');
          
          countdownNumber.textContent = "!!!";
          countdown.querySelector('.countdown-message').textContent = "B·∫•t ng·ªù ƒë√¢y!";
          countdown.classList.add('active');
          
          setTimeout(() => {
            bgMusic.play();
            musicPlayer.innerHTML = '<div class="music-icon">üîä</div>';
            countdown.classList.remove('active');
            
            // T·∫°o hi·ªáu ·ª©ng ph√°o hoa l·ªõn
            createFireworks(20);
          }, 1500);
        }
      });
    }
    
  // ===== Candle control =====
  const cakeEl = document.querySelector('.cake');
  const btnBlow = document.querySelector('#btnBlow');
  const btnLight = document.querySelector('#btnLight');
  if(btnBlow) btnBlow.addEventListener('click',()=> cakeEl.classList.add('candle-off'));
  if(btnLight) btnLight.addEventListener('click',()=> cakeEl.classList.remove('candle-off'));

  // Popup
  const btn = document.getElementById("gbAdd");
  const popup = document.getElementById("thankPopup");
  const closeBtn = document.querySelector(".popup-close");

  btn.addEventListener("click", function(e) {
    e.preventDefault();
    popup.style.display = "flex";
    // T·ª± ·∫©n sau 3s
    setTimeout(() => { popup.style.display = "none"; }, 3000);
  });

  closeBtn.addEventListener("click", () => popup.style.display = "none");
  popup.addEventListener("click", (e) => {
    if (e.target === popup) popup.style.display = "none";
  });



  // ===== Guestbook =====
let unlockName = false; // m·∫∑c ƒë·ªãnh: ·∫©n t√™n

const gbName=$('#gbName');
const gbMsg=$('#gbMsg');
const gbList=$('#gbList');
const remain=$('#remain');
const gbCount=$('#gbCount');

function loadGB(){ try{ return JSON.parse(localStorage.getItem(GB_KEY)||'[]'); }catch{ return []; } }
function saveGB(items){ localStorage.setItem(GB_KEY, JSON.stringify(items)); }
function escapeHtml(s){ return (s+"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function getUA(){ const ua=navigator.userAgent.toLowerCase(); if(ua.includes('iphone')||ua.includes('ipad')) return 'iOS'; if(ua.includes('android')) return 'Android'; if(ua.includes('windows')) return 'Windows'; if(ua.includes('mac os')) return 'macOS'; return 'Web'; }

function renderGB(){
  const items=loadGB(); 
  gbList.innerHTML=''; 
  gbCount.textContent=items.length;

  if(!items.length){
    gbList.innerHTML='<div class="gb-empty">Ch∆∞a c√≥ l·ªùi ch√∫c n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n! ü•∞</div>'; 
    return;
  }

  items.forEach((it,idx)=>{
    const div=document.createElement('div'); 
    div.className='gb-item';

    // n·∫øu ch∆∞a m·ªü kh√≥a th√¨ che t√™n (VD: ch·ªâ hi·ªán ch·ªØ ƒë·∫ßu + ***)
    const displayName = unlockName 
      ? (it.name || '·∫®n danh') 
      : ((it.name && it.name.length > 1) 
          ? it.name[0] + '***' 
          : '·∫®n danh');

    div.innerHTML=`<h4>${escapeHtml(displayName)}</h4>
      <p>${escapeHtml(it.msg)}</p>
      <div class="gb-meta"><span>${new Date(it.ts).toLocaleString('vi-VN')}</span>${it.ua?`<span class="badge">${escapeHtml(it.ua)}</span>`:''}</div>
      <div class="gb-actions-row">
        <button class="icon-btn" data-act="copy" data-idx="${idx}">üìã Copy</button>
        <button class="icon-btn" data-act="del" data-idx="${idx}">üóëÔ∏è Xo√°</button>
      </div>`;
    gbList.appendChild(div);
  });
}

// ===== Code unlock =====
const codeBox = document.createElement("div");
codeBox.className = "code-unlock";
codeBox.innerHTML = `
  <input type="password" id="unlockCode" placeholder="Nh·∫≠p m√£ ƒë·ªÉ xem t√™n"/>
  <button id="btnUnlock">M·ªü kh√≥a</button>
`;
document.querySelector(".gb-form").appendChild(codeBox);

$('#btnUnlock').addEventListener("click", () => {
  const code = $('#unlockCode').value.trim();
  if(code === "682004"){
    unlockName = true;
    renderGB();
    alert("‚úÖ ƒê√£ m·ªü kh√≥a t√™n!");
  } else {
    alert("‚ùå M√£ kh√¥ng ƒë√∫ng!");
  }
});
  gbMsg.addEventListener('input',()=>{ remain.textContent = 200 - gbMsg.value.length; });
  $$('.chip').forEach(btn=>btn.addEventListener('click',()=>{ gbMsg.setRangeText(btn.dataset.emoji, gbMsg.selectionStart, gbMsg.selectionEnd, 'end'); gbMsg.dispatchEvent(new Event('input')); gbMsg.focus(); }));
  const FLOOD_KEY='hb:lastpost'; function canPost(){ const last=+localStorage.getItem(FLOOD_KEY)||0; return Date.now()-last>10000; }
  $('#gbAdd').addEventListener('click',()=>{ const name=(gbName.value||'·∫®n danh').trim(); const msg=(gbMsg.value||'').trim(); if(!msg){ alert('Vui l√≤ng nh·∫≠p l·ªùi ch√∫c ‚ù§Ô∏è'); return; } if(!canPost()){ alert('Ch·∫≠m l·∫°i ch√∫t nh√© üê¢ (10s m·ªói l·∫ßn)'); return; } const it={name, msg:msg.slice(0,200), ts:Date.now(), ua:getUA()}; const items=loadGB(); items.unshift(it); saveGB(items); localStorage.setItem(FLOOD_KEY, Date.now()); gbMsg.value=''; gbName.value=''; remain.textContent='200'; renderGB(); });
  gbList.addEventListener('click',(e)=>{ const btn=e.target.closest('button'); if(!btn) return; const idx=+btn.dataset.idx; const act=btn.dataset.act; const items=loadGB(); if(!(idx in items)) return; if(act==='del'){ if(confirm('Xo√° l·ªùi ch√∫c n√†y?')){ items.splice(idx,1); saveGB(items); renderGB(); } } if(act==='copy'){ navigator.clipboard.writeText(`${items[idx].name}: ${items[idx].msg}`).then(()=>{ btn.textContent='‚úÖ ƒê√£ copy'; setTimeout(()=>btn.textContent='üìã Copy',1200); }); } });
  $('#btnExport').addEventListener('click',()=>{ const data=JSON.stringify(loadGB(),null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`guestbook-${sanitizeKey(CONFIG.recipientName)}.json`; a.click(); URL.revokeObjectURL(url); });
  $('#btnImport').addEventListener('click',()=>$('#fileInput').click());
  $('#fileInput').addEventListener('change', async (e)=>{ const file=e.target.files[0]; if(!file) return; try{ const text=await file.text(); const arr=JSON.parse(text); if(Array.isArray(arr)){ saveGB(arr); renderGB(); } else alert('T·∫≠p tin kh√¥ng h·ª£p l·ªá'); } catch{ alert('Kh√¥ng th·ªÉ ƒë·ªçc t·∫≠p tin'); } e.target.value=''; });
  $('#btnShare').addEventListener('click', async ()=>{ const shareData={ title:document.title, text:`Thi·ªáp m·ª´ng ${CONFIG.recipientName} üéÇ`, url:location.href }; if(navigator.share){ try{ await navigator.share(shareData); }catch{} } else { await navigator.clipboard.writeText(location.href); alert('ƒê√£ copy li√™n k·∫øt!'); } });
  $('#btnPrint').addEventListener('click',()=>window.print());
  $('#btnClear').addEventListener('click',()=>{ if(confirm('Xo√° to√†n b·ªô l·ªùi ch√∫c?')){ saveGB([]); renderGB(); } });
  renderGB();
  $('#btnConfetti').setAttribute('aria-label','B·∫Øn confetti'); $('#btnFireworks').setAttribute('aria-label','Ph√°o hoa');
  try{ const qp=new URLSearchParams(location.search); qp.set('name', CONFIG.recipientName); qp.set('author', CONFIG.author); qp.set('birthday', CONFIG.birthday); history.replaceState({}, '', `${location.pathname}?${qp.toString()}`); }catch{}
  </script>
</body>
</html>
